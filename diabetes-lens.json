{
  "resourceType": "Library",
  "id": "diabetes-lens",
  "meta": {
    "profile": [
      "http://hl7.eu/fhir/ig/gravitate-health/StructureDefinition/lens"
    ]
  },
  "type": {
    "coding": [
      {
        "code": "logical-library"
      }
    ]
  },
  "extension": [
    {
      "url": "http://hl7.eu/fhir/ig/gravitate-health/StructureDefinition/lee-version",
      "valueString": "dev"
    }
  ],
  "url": "http://hl7.eu/fhir/ig/gravitate-health/Library/588",
  "identifier": [
    {
      "system": "http://gravitate-health.lst.tfo.upm.es",
      "value": "diabetes-lens"
    }
  ],
  "version": "0.0.1",
  "name": "Diabetes lens",
  "_name": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente para la diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente para a diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Linse til diabetes"
          }
        ]
      }
    ]
  },
  "title": "diabetes-lens",
  "_title": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente para la diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente para a diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Linse til diabetes"
          }
        ]
      }
    ]
  },
  "status": "draft",
  "experimental": true,
  "date": "2024-06-12T12:23:10.005Z",
  "publisher": "Gravitate Health Project - UPM Team",
  "contact": [
    {
      "name": "Gravitate Health",
      "telecom": [
        {
          "system": "url",
          "value": "https://www.gravitatehealth.eu/"
        }
      ]
    }
  ],
  "description": "Lens that highlight diabetes related information",
  "_description": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente que resalta informaci\u00f3n relacionada con la diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente que destaca informa\u00e7\u00f5es relacionadas com a diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Linse der fremh\u00e6ver diabetesrelaterede oplysninger"
          }
        ]
      }
    ]
  },
  "jurisdiction": [
    {
      "coding": [
        {
          "code": "EU",
          "system": "urn:iso:std:iso:3166"
        }
      ]
    }
  ],
  "purpose": "Highlight diabetes related information in a preprocessed ePI.",
  "_purpose": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Resaltar informaci\u00f3n relacionada con la diabetes en una ePI preprocesada."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Destacar informa\u00e7\u00f5es relacionadas com a diabetes em uma ePI pr\u00e9-processada."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Fremh\u00e6v diabetesrelaterede oplysninger i en forbehandlet ePI."
          }
        ]
      }
    ]
  },
  "usage": "You can import this lens directly to your FHIR Server which suports Library Resource type.",
  "_usage": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Puedes importar esta lente directamente a tu servidor FHIR que soporte el tipo de recurso Library."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Podes importar esta lente diretamente para o teu servidor FHIR que suporte o tipo de recurso Library."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Du kan importere denne linse direkte til din FHIR-server, som underst\u00f8tter ressource-typen Library."
          }
        ]
      }
    ]
  },
  "copyright": "\u00a9 2024 Gravitate Health",
  "parameter": [
    {
      "use": "in",
      "documentation": "parameter if it exists",
      "type": "CodeableConcept"
    }
  ],
  "content": [
    {
      "contentType": "application/javascript",
      "title": "Lens for diabetes",
      "data": "CmxldCBwdkRhdGEgPSBwdgpsZXQgaHRtbERhdGEgPSBodG1sCgpsZXQgZXBpRGF0YSA9IGVwaTsKbGV0IGlwc0RhdGEgPSBpcHM7CgpsZXQgZ2V0U3BlY2lmaWNhdGlvbiA9ICgpID0+IHsKICAgIHJldHVybiAiMS4wLjAiCn0KCmxldCBhbm5vdGF0aW9uUHJvY2VzcyA9IChsaXN0T2ZDYXRlZ29yaWVzLCBlbmhhbmNlVGFnLCBkb2N1bWVudCwgcmVzcG9uc2UpID0+IHsKICAgIGxpc3RPZkNhdGVnb3JpZXMuZm9yRWFjaCgoY2hlY2spID0+IHsKICAgICAgICBpZiAocmVzcG9uc2UuaW5jbHVkZXMoY2hlY2spKSB7CiAgICAgICAgICAgIGxldCBlbGVtZW50cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2hlY2spOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50c1tpXS5jbGFzc0xpc3QuYWRkKGVuaGFuY2VUYWcpOwogICAgICAgICAgICAgICAgZWxlbWVudHNbaV0uY2xhc3NMaXN0LmFkZCgiZGlhYmV0ZXMtbGVucyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0ucmVtb3ZlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IikubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdLmlubmVySFRNTDsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIHJlc3BvbnNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUwpOwogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgaWYgKHJlc3BvbnNlID09IG51bGwgfHwgcmVzcG9uc2UgPT0gIiIpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICJBbm5vdGF0aW9uIHByb2NjZXNzIGZhaWxlZDogUmV0dXJuZWQgZW1wdHkgb3IgbnVsbCByZXNwb25zZSIKICAgICAgICApOwogICAgICAgIC8vcmV0dXJuIGh0bWxEYXRhCiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIHJlc3BvbnNlKTsKICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICB9Cn0KCmxldCBhbm5vdGF0ZUhUTUxzZWN0aW9uID0gYXN5bmMgKGxpc3RPZkNhdGVnb3JpZXMsIGVuaGFuY2VUYWcpID0+IHsKICAgIGxldCByZXNwb25zZSA9IGh0bWxEYXRhOwogICAgbGV0IGRvY3VtZW50OwoKICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgICAgIGxldCBqc2RvbSA9IGF3YWl0IGltcG9ydCgianNkb20iKTsKICAgICAgICBsZXQgeyBKU0RPTSB9ID0ganNkb207CiAgICAgICAgbGV0IGRvbSA9IG5ldyBKU0RPTShodG1sRGF0YSk7CiAgICAgICAgZG9jdW1lbnQgPSBkb20ud2luZG93LmRvY3VtZW50OwogICAgICAgIHJldHVybiBhbm5vdGF0aW9uUHJvY2VzcyhsaXN0T2ZDYXRlZ29yaWVzLCBlbmhhbmNlVGFnLCBkb2N1bWVudCwgcmVzcG9uc2UpOwogICAgfSBlbHNlIHsKICAgICAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsKICAgICAgICByZXR1cm4gYW5ub3RhdGlvblByb2Nlc3MobGlzdE9mQ2F0ZWdvcmllcywgZW5oYW5jZVRhZywgZG9jdW1lbnQsIHJlc3BvbnNlKTsKICAgIH0KfTsKCmxldCBlbmhhbmNlID0gYXN5bmMgKCkgPT4gewogICAgbGV0IGxpc3RPZkNhdGVnb3JpZXNUb1NlYXJjaCA9IFsiY29udHJhLWluZGljYXRpb24tZGlhYmV0ZXMtbWVsbGl0dXMiXQoKICAgIC8vSVBTIGludGVyYWN0aW9uIG5vdCBpbXBsZW1lbnRlZCB5ZXQKCiAgICAvL0dldCBjb25kaXRpb24gY2F0ZWdvcmllcyBmb3IgdGhlIGVQSSBhbmQgZmlsdGVycyBieSB0aGUgY29uZGl0aW9uIHdlIHdhbnQgdG8gY2hlY2sKICAgIGxldCBjYXRlZ29yaWVzID0gW10KICAgIGVwaS5lbnRyeS5mb3JFYWNoKGVsZW1lbnQgPT4gewogICAgICAgIGlmIChlbGVtZW50LnJlc291cmNlLmV4dGVuc2lvbiAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZWxlbWVudC5yZXNvdXJjZS5leHRlbnNpb24uZm9yRWFjaChjYXRlZ29yeSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobGlzdE9mQ2F0ZWdvcmllc1RvU2VhcmNoLmluY2x1ZGVzKGNhdGVnb3J5LmV4dGVuc2lvblswXS52YWx1ZVN0cmluZykpIHsKICAgICAgICAgICAgICAgICAgICBjYXRlZ29yaWVzLnB1c2goY2F0ZWdvcnkuZXh0ZW5zaW9uWzBdLnZhbHVlU3RyaW5nKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvL0ZvY3VzIChhZGRzIGhpZ2hsaWdodCBjbGFzcykgdGhlIGh0bWwgYXBwbHlpbmcgZXZlcnkgY2F0ZWdvcnkgZm91bmQKCiAgICBpZiAoY2F0ZWdvcmllcy5sZW5ndGggPT0gMCkgewogICAgICAgIC8vIHRocm93IG5ldyBFcnJvcigiTm8gY2F0ZWdvcmllcyBmb3VuZCIsIGNhdGVnb3JpZXMpOwogICAgICAgIHJldHVybiBodG1sRGF0YQogICAgfQogICAgLy9Gb2N1cyAoYWRkcyBoaWdobGlnaHQgY2xhc3MpIHRoZSBodG1sIGFwcGx5aW5nIGV2ZXJ5IGNhdGVnb3J5IGZvdW5kCiAgICByZXR1cm4gYXdhaXQgYW5ub3RhdGVIVE1Mc2VjdGlvbihjYXRlZ29yaWVzLCAiaGlnaGxpZ2h0Iik7Cn0KcmV0dXJuIHsKICAgIGVuaGFuY2U6IGVuaGFuY2UsCiAgICBnZXRTcGVjaWZpY2F0aW9uOiBnZXRTcGVjaWZpY2F0aW9uCn0=",
      "_title": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/StructureDefinition/translation",
            "extension": [
              {
                "url": "lang",
                "valueCode": "es"
              },
              {
                "url": "content",
                "valueString": "Lente para la diabetes"
              }
            ]
          },
          {
            "url": "http://hl7.org/fhir/StructureDefinition/translation",
            "extension": [
              {
                "url": "lang",
                "valueCode": "pt"
              },
              {
                "url": "content",
                "valueString": "Lente para a diabetes"
              }
            ]
          },
          {
            "url": "http://hl7.org/fhir/StructureDefinition/translation",
            "extension": [
              {
                "url": "lang",
                "valueCode": "da"
              },
              {
                "url": "content",
                "valueString": "Linse til diabetes"
              }
            ]
          }
        ]
      }
    }
  ],
  "data": "CmxldCBwdkRhdGEgPSBwdgpsZXQgaHRtbERhdGEgPSBodG1sCgpsZXQgZXBpRGF0YSA9IGVwaTsKbGV0IGlwc0RhdGEgPSBpcHM7CgpsZXQgZ2V0U3BlY2lmaWNhdGlvbiA9ICgpID0+IHsKICAgIHJldHVybiAiMS4wLjAiCn0KCi8vZm9yIGZ1dHVyZSB1c2U/CmZ1bmN0aW9uIGxvYWRDaGVja2xpc3QobGFuZ3VhZ2UpIHsKICAgIGlmIChsYW5ndWFnZURldGVjdGVkPy5zdGFydHNXaXRoKCJwdCIpKSB7CiAgICAgICAgZmlsZW5hbWUgPSAiY2hlY2tsaXN0LXB0Lmh0bWwiOwogICAgfSBlbHNlIGlmIChsYW5ndWFnZURldGVjdGVkPy5zdGFydHNXaXRoKCJlbiIpKSB7CiAgICAgICAgZmlsZW5hbWUgPSAiY2hlY2tsaXN0LXB0Lmh0bWwiOwogICAgfSBlbHNlIHsgLy9zaG91bGQgd2UgaGF2ZSB0aGlzPwogICAgICAgIGZpbGVuYW1lID0gImNoZWNrbGlzdC1wdC5odG1sIjsKICAgIH0KCiAgICBjb25zdCB0YXJnZXRFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNoZWNrbGlzdC1jb250YWluZXIiKTsKICAgIGlmICghdGFyZ2V0RWxlbWVudCkgewogICAgICAgIGNvbnNvbGUud2Fybigi8J+bkSBDaGVja2xpc3QgY29udGFpbmVyIG5vdCBmb3VuZC4iKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgZmV0Y2goYGNoZWNrbGlzdHMvJHtmaWxlbmFtZX1gKQogICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB0aHJvdyBuZXcgRXJyb3IoIkZhaWxlZCB0byBsb2FkIGNoZWNrbGlzdC4iKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnRleHQoKTsKICAgICAgICB9KQogICAgICAgIC50aGVuKChodG1sKSA9PiB7CiAgICAgICAgICAgIHRhcmdldEVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgY29uc29sZS5sb2coYOKchSBMb2FkZWQgY2hlY2tsaXN0OiAke2ZpbGVuYW1lfWApOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCLinYwgRXJyb3IgbG9hZGluZyBjaGVja2xpc3Q6IiwgZXJyb3IpOwogICAgICAgIH0pOwp9CgoKCmNvbnN0IGluc2VydENoZWNrTGlzdExpbmsgPSAobGlzdE9mQ2F0ZWdvcmllcywgbGFuZ3VhZ2UsIGRvY3VtZW50LCByZXNwb25zZSkgPT4gewoKICAgIGlmIChsYW5ndWFnZT8uc3RhcnRzV2l0aCgicHQiKSkgewogICAgICAgIGNoZWNrbGlzdCA9IGAKICAgICAgICA8ZGl2IGNsYXNzPSJjaGVja2xpc3QiPgogICAgICAgICAgPGgzPvCfk4sgTGlzdGEgZGUgVmVyaWZpY2HDp8OjbzwvaDM+CiAgICAgICAgICA8cD5Fc3RlIG1lZGljYW1lbnRvIHBvZGUgc2VyIGNvbXBsaWNhZG8gZGUgdXNhciwgcG9yIGlzc28gYXF1aSBlc3TDoSB1bWEgbGlzdGEgZGUgdmVyaWZpY2HDp8OjbyBwYXJhIHNlIGxlbWJyYXIgZG8gcXVlIHZlcmlmaWNhciBhbnRlY2lwYWRhbWVudGUuPC9wPgogICAgICAgICAgPHVsPgogICAgICAgICAgICA8bGk+PGxhYmVsPjxpbnB1dCB0eXBlPSJjaGVja2JveCI+IFJldmVyIGxpc3RhIGRlIG1lZGljYcOnw6NvPC9sYWJlbD48L2xpPgogICAgICAgICAgICA8bGk+PGxhYmVsPjxpbnB1dCB0eXBlPSJjaGVja2JveCI+IENvbmZpcm1hciBhbGVyZ2lhcyBkbyBwYWNpZW50ZTwvbGFiZWw+PC9saT4KICAgICAgICAgICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBFbnZpYXIgZS1tYWlsIGRlIHNlZ3VpbWVudG88L2xhYmVsPjwvbGk+CiAgICAgICAgICAgIDxsaT48bGFiZWw+PGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gQXR1YWxpemFyIGhpc3TDs3JpY28gY2zDrW5pY288L2xhYmVsPjwvbGk+CiAgICAgICAgICAgIDxsaT48bGFiZWw+PGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gTWFyY2FyIHByw7N4aW1hIGNvbnN1bHRhPC9sYWJlbD48L2xpPgogICAgICAgICAgPC91bD4KICAgICAgICA8L2Rpdj4KICAgICAgYDsKICAgIH0gZWxzZSBpZiAobGFuZ3VhZ2U/LnN0YXJ0c1dpdGgoImVuIikpIHsKICAgICAgICBjaGVja2xpc3QgPSBgCiAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2tsaXN0Ij4KICA8aDM+8J+TiyBDaGVja2xpc3Q8L2gzPgogIDxwPlRoaXMgRHJ1ZyBjYW4gYmUgY29tcGxpY2F0ZWQgdG8gdXNlLCBzbyBoZXJlIGlzIGEgY2hlY2tsaXN0IGZvciB5b3UgdG8gcmVtZW1iZXIgdG8gY2hlY2sgdGhpbmdzIGJlZm9yZS48L3A+CiAgPHVsPgogICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBSZXZpZXcgbWVkaWNhdGlvbiBsaXN0PC9sYWJlbD48L2xpPgogICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBDb25maXJtIHBhdGllbnQgYWxsZXJnaWVzPC9sYWJlbD48L2xpPgogICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBTZW5kIGZvbGxvdy11cCBlbWFpbDwvbGFiZWw+PC9saT4KICAgIDxsaT48bGFiZWw+PGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gVXBkYXRlIG1lZGljYWwgaGlzdG9yeTwvbGFiZWw+PC9saT4KICAgIDxsaT48bGFiZWw+PGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gU2NoZWR1bGUgbmV4dCBhcHBvaW50bWVudDwvbGFiZWw+PC9saT4KICA8L3VsPgo8L2Rpdj4KICAgICAgYDsKICAgIH0gZWxzZSBpZiAobGFuZ3VhZ2U/LnN0YXJ0c1dpdGgoImVzIikpIHsKICAgICAgICBjaGVja2xpc3QgPSBgCiAgICAgICAgPGRpdiBjbGFzcz0iY2hlY2tsaXN0Ij4KICAgICAgICAgIDxoMz7wn5OLIExpc3RhIGRlIENvbXByb2JhY2nDs248L2gzPgogICAgICAgICAgPHA+RXN0ZSBtZWRpY2FtZW50byBwdWVkZSBzZXIgY29tcGxpY2FkbyBkZSB1c2FyLCBhc8OtIHF1ZSBhcXXDrSB0aWVuZXMgdW5hIGxpc3RhIGRlIGNvbXByb2JhY2nDs24gcGFyYSByZWNvcmRhciBsbyBxdWUgZGViZXMgcmV2aXNhciBhbnRlcy48L3A+CiAgICAgICAgICA8dWw+CiAgICAgICAgICAgIDxsaT48bGFiZWw+PGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gUmV2aXNhciBsaXN0YSBkZSBtZWRpY2FtZW50b3M8L2xhYmVsPjwvbGk+CiAgICAgICAgICAgIDxsaT48bGFiZWw+PGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gQ29uZmlybWFyIGFsZXJnaWFzIGRlbCBwYWNpZW50ZTwvbGFiZWw+PC9saT4KICAgICAgICAgICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBFbnZpYXIgY29ycmVvIGRlIHNlZ3VpbWllbnRvPC9sYWJlbD48L2xpPgogICAgICAgICAgICA8bGk+PGxhYmVsPjxpbnB1dCB0eXBlPSJjaGVja2JveCI+IEFjdHVhbGl6YXIgaGlzdG9yaWFsIG3DqWRpY288L2xhYmVsPjwvbGk+CiAgICAgICAgICAgIDxsaT48bGFiZWw+PGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gUHJvZ3JhbWFyIHByw7N4aW1hIGNpdGE8L2xhYmVsPjwvbGk+CiAgICAgICAgICA8L3VsPgogICAgICAgIDwvZGl2PgogICAgICBgOwogICAgfSBlbHNlIGlmIChsYW5ndWFnZT8uc3RhcnRzV2l0aCgiZGEiKSkgewogICAgICAgIGNoZWNrbGlzdCA9IGAKICAgICAgICA8ZGl2IGNsYXNzPSJjaGVja2xpc3QiPgogICAgICAgICAgPGgzPvCfk4sgVGpla2xpc3RlPC9oMz4KICAgICAgICAgIDxwPkRlbm5lIG1lZGljaW4ga2FuIHbDpnJlIGtvbXBsaWNlcmV0IGF0IGJydWdlLCBzw6UgaGVyIGVyIGVuIHRqZWtsaXN0ZSwgZGVyIGthbiBoasOmbHBlIGRpZyBtZWQgYXQgaHVza2UsIGh2YWQgZHUgc2thbCBrb250cm9sbGVyZS48L3A+CiAgICAgICAgICA8dWw+CiAgICAgICAgICAgIDxsaT48bGFiZWw+PGlucHV0IHR5cGU9ImNoZWNrYm94Ij4gR2VubmVtZ8OlIG1lZGljaW5saXN0ZTwvbGFiZWw+PC9saT4KICAgICAgICAgICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBCZWtyw6ZmdCBwYXRpZW50ZW5zIGFsbGVyZ2llcjwvbGFiZWw+PC9saT4KICAgICAgICAgICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBTZW5kIG9wZsO4bGdlbmRlIGUtbWFpbDwvbGFiZWw+PC9saT4KICAgICAgICAgICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBPcGRhdGVyIG1lZGljaW5zayBoaXN0b3JpazwvbGFiZWw+PC9saT4KICAgICAgICAgICAgPGxpPjxsYWJlbD48aW5wdXQgdHlwZT0iY2hlY2tib3giPiBQbGFubMOmZyBuw6ZzdGUgYWZ0YWxlPC9sYWJlbD48L2xpPgogICAgICAgICAgPC91bD4KICAgICAgICA8L2Rpdj4KICAgICAgYDsKICAgIH0KICAgIGxldCBmb3VuZENhdGVnb3J5ID0gZmFsc2U7CiAgICBjb25zb2xlLmxvZyhsaXN0T2ZDYXRlZ29yaWVzKQogICAgY29uc29sZS5sb2cobGlzdE9mQ2F0ZWdvcmllcy5sZW5ndGgpCgogICAgLy8gTm8gbWF0Y2hpbmcgY2F0ZWdvcnkgdGFncyDihpIgaW5qZWN0IGJhbm5lciBhdCB0b3AKICAgIGlmICghZm91bmRDYXRlZ29yeSkgewogICAgICAgIGNvbnN0IGJhbm5lckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGJhbm5lckRpdi5pbm5lckhUTUwgPSBjaGVja2xpc3QKCiAgICAgICAgY29uc3QgYm9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImJvZHkiKTsKICAgICAgICBpZiAoYm9keSkgewogICAgICAgICAgICBib2R5Lmluc2VydEJlZm9yZShiYW5uZXJEaXYsIGJvZHkuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIENsZWFuIGhlYWQgKHNhbWUgYXMgeW91ciBvcmlnaW5hbCBsb2dpYykKICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpLmxlbmd0aCA+IDApIHsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdLnJlbW92ZSgpOwogICAgfQoKICAgIC8vIEV4dHJhY3QgSFRNTCByZXN1bHQKICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpLmxlbmd0aCA+IDApIHsKICAgICAgICByZXNwb25zZSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uaW5uZXJIVE1MOwogICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIHJlc3BvbnNlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coIlJlc3BvbnNlOiAiICsgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTCk7CiAgICAgICAgcmVzcG9uc2UgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwogICAgfQoKICAgIGlmICghcmVzcG9uc2UgfHwgcmVzcG9uc2UudHJpbSgpID09PSAiIikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQW5ub3RhdGlvbiBwcm9jZXNzIGZhaWxlZDogZW1wdHkgb3IgbnVsbCByZXNwb25zZSIpOwogICAgfQoKICAgIHJldHVybiByZXNwb25zZTsKfTsKCmxldCBlbmhhbmNlID0gYXN5bmMgKCkgPT4gewoKICAgIGlmICghZXBpRGF0YSB8fCAhZXBpRGF0YS5lbnRyeSB8fCBlcGlEYXRhLmVudHJ5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiZVBJIGlzIGVtcHR5IG9yIGludmFsaWQuIik7CiAgICB9CiAgICAvLyBNYXRjaCBsaXN0cwogICAgY29uc3QgQlVORExFX0lERU5USUZJRVJfTElTVCA9IFsiZXBpYnVuZGxlLTEyMyIsICJlcGlidW5kbGUtYWJjIl07IC8vZHJ1Z3MgZm9yIGRpYWJldGVzCiAgICBjb25zdCBQUk9EVUNUX0lERU5USUZJRVJfTElTVCA9IFsiQ0lULTIwNDQ0NyIsICJSSVMtMTk3MzYxIl07Ly9kcnVncyBmb3IgZGlhYmV0ZXMKCiAgICBsZXQgbGlzdE9mQ2F0ZWdvcmllc1RvU2VhcmNoID0gW3sgImNvZGUiOiAiZ3Jhdi00IiwgInN5c3RlbSI6ICJodHRwczovL3d3dy5ncmF2aXRhdGVoZWFsdGguZXUvc2lkL2RvYyIgfV07IC8vd2hhdCB0byBsb29rIGluIGV4dGVuc2lvbnMgLW1hZGUgdXAgY29kZSBiZWNhdXNlIHRoZXJlIGlzIG5vbmUKCgoKICAgIGxldCBtYXRjaEZvdW5kID0gZmFsc2U7CiAgICBsZXQgbGFuZ3VhZ2VEZXRlY3RlZCA9IG51bGw7CgogICAgLy8gMS4gQ2hlY2sgQ29tcG9zaXRpb24ubGFuZ3VhZ2UKICAgIGVwaURhdGEuZW50cnk/LmZvckVhY2goKGVudHJ5KSA9PiB7CiAgICAgICAgY29uc3QgcmVzID0gZW50cnkucmVzb3VyY2U7CiAgICAgICAgaWYgKHJlcz8ucmVzb3VyY2VUeXBlID09PSAiQ29tcG9zaXRpb24iICYmIHJlcy5sYW5ndWFnZSkgewogICAgICAgICAgICBsYW5ndWFnZURldGVjdGVkID0gcmVzLmxhbmd1YWdlOwogICAgICAgICAgICBjb25zb2xlLmxvZygi8J+MjSBEZXRlY3RlZCBmcm9tIENvbXBvc2l0aW9uLmxhbmd1YWdlOiIsIGxhbmd1YWdlRGV0ZWN0ZWQpOwogICAgICAgIH0KICAgIH0pOwoKICAgIC8vIDIuIElmIG5vdCBmb3VuZCwgY2hlY2sgQnVuZGxlLmxhbmd1YWdlCiAgICBpZiAoIWxhbmd1YWdlRGV0ZWN0ZWQgJiYgZXBpRGF0YS5sYW5ndWFnZSkgewogICAgICAgIGxhbmd1YWdlRGV0ZWN0ZWQgPSBlcGlEYXRhLmxhbmd1YWdlOwogICAgICAgIGNvbnNvbGUubG9nKCLwn4yNIERldGVjdGVkIGZyb20gQnVuZGxlLmxhbmd1YWdlOiIsIGxhbmd1YWdlRGV0ZWN0ZWQpOwogICAgfQoKICAgIC8vIDMuIEZhbGxiYWNrIG1lc3NhZ2UKICAgIGlmICghbGFuZ3VhZ2VEZXRlY3RlZCkgewogICAgICAgIGNvbnNvbGUud2Fybigi4pqg77iPIE5vIGxhbmd1YWdlIGRldGVjdGVkIGluIENvbXBvc2l0aW9uIG9yIEJ1bmRsZS4iKTsKICAgIH0KCiAgICAvLyBDaGVjayBidW5kbGUuaWRlbnRpZmllci52YWx1ZQogICAgaWYgKAogICAgICAgIGVwaURhdGEuaWRlbnRpZmllciAmJgogICAgICAgIEJVTkRMRV9JREVOVElGSUVSX0xJU1QuaW5jbHVkZXMoZXBpRGF0YS5pZGVudGlmaWVyLnZhbHVlKQogICAgKSB7CiAgICAgICAgY29uc29sZS5sb2coIvCflJcgTWF0Y2hlZCBlUEkgQnVuZGxlLmlkZW50aWZpZXI6IiwgZXBpRGF0YS5pZGVudGlmaWVyLnZhbHVlKTsKICAgICAgICBtYXRjaEZvdW5kID0gdHJ1ZTsKICAgIH0KCiAgICAvLyBDaGVjayBNZWRpY2luYWxQcm9kdWN0RGVmaW5pdGlvbi5pZGVudGlmaWVyLnZhbHVlCiAgICBlcGlEYXRhLmVudHJ5LmZvckVhY2goKGVudHJ5KSA9PiB7CiAgICAgICAgY29uc3QgcmVzID0gZW50cnkucmVzb3VyY2U7CiAgICAgICAgaWYgKHJlcz8ucmVzb3VyY2VUeXBlID09PSAiTWVkaWNpbmFsUHJvZHVjdERlZmluaXRpb24iKSB7CiAgICAgICAgICAgIGNvbnN0IGlkcyA9IHJlcy5pZGVudGlmaWVyIHx8IFtdOwogICAgICAgICAgICBpZHMuZm9yRWFjaCgoaWQpID0+IHsKICAgICAgICAgICAgICAgIGlmIChQUk9EVUNUX0lERU5USUZJRVJfTElTVC5pbmNsdWRlcyhpZC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygi8J+SiiBNYXRjaGVkIE1lZGljaW5hbFByb2R1Y3REZWZpbml0aW9uLmlkZW50aWZpZXI6IiwgaWQudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIG1hdGNoRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvLyBlUEkgdHJhc2xhdGlvbiBmcm9tIHRlcm1pbm9sb2d5IGNvZGVzIHRvIHRoZWlyIGh1bWFuIHJlZGFibGUgdHJhbnNsYXRpb25zIGluIHRoZSBzZWN0aW9ucwogICAgLy8gaW4gdGhpcyBjYXNlLCBpZiBpcyBkb2VzIG5vdCBmaW5kIGEgcGxhY2UsIGFkZHMgaXQgdG8gdGhlIHRvcCBvZiB0aGUgZVBJCiAgICBsZXQgY29tcG9zaXRpb25zID0gMDsKICAgIGxldCBjYXRlZ29yaWVzID0gW107CiAgICBlcGkuZW50cnkuZm9yRWFjaCgoZW50cnkpID0+IHsKICAgICAgICBpZiAoZW50cnkucmVzb3VyY2UucmVzb3VyY2VUeXBlID09ICJDb21wb3NpdGlvbiIpIHsKICAgICAgICAgICAgY29tcG9zaXRpb25zKys7CiAgICAgICAgICAgIC8vSXRlcmF0ZWQgdGhyb3VnaCB0aGUgQ29uZGl0aW9uIGVsZW1lbnQgc2VhcmNoaW5nIGZvciBjb25kaXRpb25zCiAgICAgICAgICAgIGVudHJ5LnJlc291cmNlLmV4dGVuc2lvbi5mb3JFYWNoKChlbGVtZW50KSA9PiB7CgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHBvc2l0aW9uIG9mIHRoZSBleHRlbnNpb25bMV0gaXMgY29ycmVjdAogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZXh0ZW5zaW9uWzFdLnVybCA9PSAiY29uY2VwdCIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBTZWFyY2ggdGhyb3VnaCB0aGUgZGlmZmVyZW50IHRlcm1pbm9sb2dpZXMgdGhhdCBtYXkgYmUgYXZhaWJsZSB0byBjaGVjayBpbiB0aGUgY29uZGl0aW9uCiAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZXh0ZW5zaW9uWzFdLnZhbHVlQ29kZWFibGVSZWZlcmVuY2UuY29uY2VwdCAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5leHRlbnNpb25bMV0udmFsdWVDb2RlYWJsZVJlZmVyZW5jZS5jb25jZXB0LmNvZGluZy5mb3JFYWNoKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGNvZGluZykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJFeHRlbnNpb246ICIgKyBlbGVtZW50LmV4dGVuc2lvblswXS52YWx1ZVN0cmluZyArICI6IiArIGNvZGluZy5jb2RlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBjb2RlIGlzIGluIHRoZSBsaXN0IG9mIGNhdGVnb3JpZXMgdG8gc2VhcmNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaXN0T2ZDYXRlZ29yaWVzVG9TZWFyY2guc29tZShpdGVtID0+IGl0ZW0uY29kZSA9PT0gY29kaW5nLmNvZGUgJiYgaXRlbS5zeXN0ZW0gPT09IGNvZGluZy5zeXN0ZW0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGb3VuZCIsIGVsZW1lbnQuZXh0ZW5zaW9uWzBdLnZhbHVlU3RyaW5nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgY2F0ZWdvcnkgaXMgYWxyZWFkeSBpbiB0aGUgbGlzdCBvZiBjYXRlZ29yaWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhdGVnb3JpZXMucHVzaChlbGVtZW50LmV4dGVuc2lvblswXS52YWx1ZVN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSk7CiAgICBpZiAoY29tcG9zaXRpb25zID09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhZCBlUEk6IG5vIGNhdGVnb3J5ICJDb21wb3NpdGlvbiIgZm91bmQnKTsKICAgIH0KCiAgICBpZiAoIW1hdGNoRm91bmQpIHsKICAgICAgICBjb25zb2xlLmxvZygiZVBJIGlzIG5vdCBmb3IgYSBtZWRpY2F0aW9uIHJlcXVpcmluZyBjaGVja2xpc3QiKTsKICAgICAgICByZXR1cm4gaHRtbERhdGE7CiAgICB9CgogICAgZWxzZSB7CgoKICAgICAgICBsZXQgcmVzcG9uc2UgPSBodG1sRGF0YTsKICAgICAgICBsZXQgZG9jdW1lbnQ7CgogICAgICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBsZXQganNkb20gPSBhd2FpdCBpbXBvcnQoImpzZG9tIik7CiAgICAgICAgICAgIGxldCB7IEpTRE9NIH0gPSBqc2RvbTsKICAgICAgICAgICAgbGV0IGRvbSA9IG5ldyBKU0RPTShodG1sRGF0YSk7CiAgICAgICAgICAgIGRvY3VtZW50ID0gZG9tLndpbmRvdy5kb2N1bWVudDsKICAgICAgICAgICAgcmV0dXJuIGluc2VydENoZWNrTGlzdExpbmsoY2F0ZWdvcmllcywgbGFuZ3VhZ2VEZXRlY3RlZCwgZG9jdW1lbnQsIHJlc3BvbnNlKTsKICAgICAgICAgICAgLy9saXN0T2ZDYXRlZ29yaWVzLCBlbmhhbmNlVGFnLCBkb2N1bWVudCwgcmVzcG9uc2UKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsKICAgICAgICAgICAgcmV0dXJuIGluc2VydENoZWNrTGlzdExpbmsoY2F0ZWdvcmllcywgbGFuZ3VhZ2VEZXRlY3RlZCwgZG9jdW1lbnQsIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICB9Owp9OwoKcmV0dXJuIHsKICAgIGVuaGFuY2U6IGVuaGFuY2UsCiAgICBnZXRTcGVjaWZpY2F0aW9uOiBnZXRTcGVjaWZpY2F0aW9uLAp9Ow=="
}